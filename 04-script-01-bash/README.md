# Домашнее задание к занятию "4.1. Командная оболочка Bash: Практические навыки"

## Обязательные задания

1. Есть скрипт:
	```bash
	a=1
	b=2
	c=a+b
	d=$a+$b
	e=$(($a+$b))
	```
	* Какие значения переменным c,d,e будут присвоены?

	```bash
	vagrant@vagrant:~$ c=a+b
	vagrant@vagrant:~$ echo $c
	a+b
	```
	```bash
	vagrant@vagrant:~$ d=$a+$b
	vagrant@vagrant:~$ echo $d
	1+2
	```
	```bash
	vagrant@vagrant:~$ e=$(($a+$b))
	vagrant@vagrant:~$ echo $e
	3
	```

	* Почему?

	`c=a+b = a+b` - так-как апеременные строки и указаны буквы.  
	`d=$a+$b = 1+2` - так-как апеременные строки и вывод строка, а не арифметическое действие.  
	`e=$(($a+$b)) = 3` - за счёт (()) произвелось арифметическое действие над целыми числами.  


	| Переменная  | Значение | Обоснование |
	| ------------- | ------------- | ------------- |
	| `c`  | a+b  | так-как апеременные строки и указаны буквы.
	| `d`  | 1+2  | так-как апеременные строки и вывод строка, а не арифметическое действие. 
	| `e`  | 3    | за счёт (()) произвелось арифметическое действие над целыми числами. 



1. На нашем локальном сервере упал сервис и мы написали скрипт, который постоянно проверяет его доступность, записывая дату проверок до тех пор, пока сервис не станет доступным. В скрипте допущена ошибка, из-за которой выполнение не может завершиться, при этом место на Жёстком Диске постоянно уменьшается. Что необходимо сделать, чтобы его исправить:
	```bash
	while ((1==1)
	do
	curl https://localhost:4757
	if (($? != 0))
	then
	date >> curl.log
	fi
	done
	```

    * Установил nginx для теста скрипта.

	```bash
	#!/bin/bash
	while ((1 == 1)); do
		curl http://localhost
		if (($? != 0)); then
			date >>curl.log
			sleep 1
		fi
	done
	```
	Не хватало скобки `while ((1==1))`  
	Добавил `sleep 1` -  для задержки опроса в 1 секунду.  
	По сути этого достаточно чтобы лог не писался после того как сервис станет доступный, но можно добавить `else exit` тогда вывод прикратится.   

	Финальный вариант скрипта.  

	```bash
	while ((1 == 1)); do
		curl http://localhost
		if (($? != 0)); then
			date >>curl.log
			sleep 1
		else
			exit
		fi
	done
	```  

	* Если из другой консоли запускать `sudo service nginx start` и останавливать `sudo service nginx stop` то файл лога curl.log ,будет заполняться и можно проверить работу скрипта.   
	Содержимое curl.log  
	```bash
	...
	Wed 15 Dec 2021 10:32:26 AM UTC
	Wed 15 Dec 2021 10:32:26 AM UTC
	Wed 15 Dec 2021 10:32:26 AM UTC
	Wed 15 Dec 2021 10:32:26 AM UTC
	...
	```




1. Необходимо написать скрипт, который проверяет доступность трёх IP: 192.168.0.1, 173.194.222.113, 87.250.250.242 по 80 порту и записывает результат в файл log. Проверять доступность необходимо пять раз для каждого узла.

	```bash
	#!/bin/bash
	ips=(192.168.0.1 173.194.222.113 87.250.250.24)
	timeout=5
	log=ip_log.log
	check='curl -Is --connect-timeout'
	for i in {1..5}; do
		date >>$log
		for host in ${ips[@]}; do
			$check $timeout http://$host >/dev/null

			if (($? == 0)); then
				status="http UP"
			else
				status="http DOWN"
			fi

			echo $host $status >>$log
		done
	done

	```
	ip_log.log   
	```
	Wed 15 Dec 2021 01:12:11 PM UTC
	192.168.0.1 http DOWN
	173.194.222.113 http UP
	87.250.250.24 http DOWN
	...
	```

1. Необходимо дописать скрипт из предыдущего задания так, чтобы он выполнялся до тех пор, пока один из узлов не окажется недоступным. Если любой из узлов недоступен - IP этого узла пишется в файл error, скрипт прерывается


	```bash
	#!/bin/bash
	ips=(192.168.0.1 173.194.222.113 87.250.250.24)
	timeout=5
	log=ip_log.log
	errorlog=ip_error.log
	check='curl -Is --connect-timeout'
	for i in {1..5}; do
		date >>$log
		for host in ${ips[@]}; do
			$check $timeout http://$host >/dev/null

			if (($? == 0)); then
				status="http UP"
				echo $host $status >>$log
			else
				status="http DOWN"
				echo $host $status >>$errorlog
				exit
			fi

		done
	done
	```

## Дополнительное задание (со звездочкой*) - необязательно к выполнению

Мы хотим, чтобы у нас были красивые сообщения для коммитов в репозиторий. Для этого нужно написать локальный хук для git, который будет проверять, что сообщение в коммите содержит код текущего задания в квадратных скобках и количество символов в сообщении не превышает 30. Пример сообщения: \[04-script-01-bash\] сломал хук.

```bash
!#/bin/bash
test "" = "$(grep '^Signed-off-by: ' "$1" |
         sort | uniq -c | sed -e '/^[   ]*1[    ]/d')" || {
        echo >&2 Duplicate Signed-off-by lines.
        exit 1
}

commit='^(DevSys-[0-9])'
if ! grep -qE "$commit" "$1"; then
    echo "Commit message [DevSys-00-test]"
    exit 1
fi
```